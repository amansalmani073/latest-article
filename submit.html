<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Your Blog | Global Travel Guide</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>

    <style>
        :root { --primary-color: #ff5722; --dark-color: #1a1a1a; --light-bg: #f5f7fa; }
        body { font-family: 'Poppins', sans-serif; background: var(--light-bg); padding: 50px 20px; }
        .form-container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; display: block; }
        .submit-btn { background: var(--primary-color); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; margin-top: 20px; }
        .submit-btn:hover { background: #e64a19; }
        .back-link { display: block; text-align: center; margin-top: 20px; text-decoration: none; color: #666; font-size: 14px; }
        
        .ck-editor__editable { min-height: 300px !important; margin-bottom: 10px; }
        #user-info { text-align: right; font-size: 12px; color: #ff5722; margin-bottom: 10px; font-weight: 600; }
    </style>
</head>
<body>

<div class="form-container">
    <div id="user-info">Checking access...</div>
    <h2 style="text-align: center; color: var(--dark-color); margin-bottom: 20px;">Share Your Travel Story</h2>
    <form id="postForm">
        <input type="text" id="title" placeholder="Article Title (e.g. My Trip to Dubai)" required>
        <input type="text" id="author" placeholder="Your Name" required>
        
        <select id="category" required>
            <option value="" disabled selected>Select Category (Where to post?)</option>
            <option value="visa-guides">Visa Guide</option>
            <option value="travel-tips">Travel Tips</option>
            <option value="destination-guides">Destination Guide</option>
        </select>
        
        <div id="editor-container">
            <textarea id="editor" placeholder="Write your story here..."></textarea>
        </div>
        
        <button type="submit" class="submit-btn">Publish My Blog</button>
    </form>
    <a href="/latest-article/" class="back-link">‚Üê Back to Home</a>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCBSTMLjE8h9saIldRcuKbaKp84t5hx9s",
    authDomain: "latest-article.firebaseapp.com",
    projectId: "latest-article",
    storageBucket: "latest-article.firebasestorage.app",
    messagingSenderId: "222132959003",
    appId: "1:222132959003:web:a329d719efb6cf7c105be"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // LOGIN CHECK: Agar login nahi hai toh login page par bhej do
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      alert("Please login first to post a blog.");
      window.location.href = "/latest-article/login.html";
    } else {
      document.getElementById('user-info').innerText = "Logged in as: " + user.email;
    }
  });

  let blogEditor;
  ClassicEditor
    .create(document.querySelector('#editor'))
    .then(editor => {
        blogEditor = editor;
    })
    .catch(error => {
        console.error("Editor error:", error);
    });

  document.getElementById('postForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button');
    const blogContent = blogEditor.getData();
    const category = document.getElementById('category').value;

    if (!blogContent || blogContent.trim() === "") {
        alert("Please write something in the content area.");
        return;
    }

    btn.innerText = "Publishing...";
    btn.disabled = true;

    try {
      await addDoc(collection(db, "user_blogs"), {
        title: document.getElementById('title').value,
        author: document.getElementById('author').value,
        authorEmail: auth.currentUser.email, // Logged-in user ki email save hogi
        category: category,
        content: blogContent,
        timestamp: serverTimestamp()
      });
      
      alert("Thank you! Published successfully.");
      window.location.href = "/latest-article/"; 
    } catch (err) {
      alert("Error: " + err.message);
      btn.disabled = false;
      btn.innerText = "Publish My Blog";
    }
  });
</script>

</body>
</html>
